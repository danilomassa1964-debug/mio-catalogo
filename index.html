<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Catalogo Serigrafia</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

    <style>
        body { background-color: #1a1a1a; color: white; margin: 0; overflow: hidden; font-family: sans-serif; }
        
        .toolbar {
            background: rgba(0,0,0,0.9);
            padding: 10px;
            position: fixed;
            top: 0; width: 100%;
            z-index: 1000;
            display: flex; justify-content: center; gap: 10px;
        }

        #canvas-container { 
            margin-top: 80px;
            width: 100vw;
            height: calc(100vh - 80px);
            display: flex;
            justify-content: center; /* Centra orizzontalmente */
            align-items: flex-start; /* Allinea in alto */
        }

        #flipbook { 
            display: none; 
            margin: 0 auto;
        }

        .page { background-color: white; }
        canvas { width: 100%; height: 100%; display: block; }

        button { 
            padding: 10px 15px; background: #333; color: white; 
            border: 1px solid #555; border-radius: 5px; cursor: pointer;
        }

        #loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 2000; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <button onclick="changeZoom(-0.1)">➖</button>
        <button onclick="changeZoom(0.1)">➕</button>
        <button onclick="$('#flipbook').turn('previous')">← Prec</button>
        <button onclick="$('#flipbook').turn('next')">Succ →</button>
    </div>

    <div id="loading">Caricamento in corso...</div>
    
    <div id="canvas-container">
        <div id="flipbook"></div>
    </div>

    <script>
        let pdfDoc = null;
        const url = 'documento.pdf';
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        function changeZoom(delta) {
            // Invece di zoomare l'intero contenitore, qui usiamo un approccio più semplice
            let currentScale = parseFloat($('#canvas-container').css('transform').split(',')[3]) || 1;
            let newScale = currentScale + delta;
            if (newScale > 0.3) {
                $('#canvas-container').css('transform', `scale(${newScale})`).css('transform-origin', 'top center');
            }
        }

        async function init() {
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                const fb = $('#flipbook');

                // 1. Leggiamo le dimensioni reali della prima pagina
                const firstPage = await pdfDoc.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1.0 });

                // 2. Calcoliamo lo spazio disponibile
                const screenWidth = window.innerWidth * 0.8;
                const screenHeight = window.innerHeight * 0.7;
                
                // Rapporto per far stare due pagine nello schermo
                let ratio = Math.min(screenWidth / (viewport.width * 2), screenHeight / viewport.height);
                
                const bookWidth = (viewport.width * 2) * ratio;
                const bookHeight = viewport.height * ratio;

                // 3. Creiamo le pagine
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    fb.append(`<div class="page" id="page-${i}"><canvas></canvas></div>`);
                }

                // 4. Inizializziamo Turn.js
                fb.show().turn({
                    width: bookWidth,
                    height: bookHeight,
                    autoCenter: true, // Cruciale per la copertina
                    display: 'double',
                    pages: pdfDoc.numPages,
                    acceleration: true,
                    when: {
                        turning: function(e, page) {
                            renderPage(page);
                            if (page + 1 <= pdfDoc.numPages) renderPage(page + 1);
                        }
                    }
                });

                await renderPage(1);
                await renderPage(2);
                $('#loading').fadeOut();

            } catch (err) {
                console.error(err);
                $('#loading').text("Errore nel caricamento del PDF.");
            }
        }

        async function renderPage(num) {
            const pageDiv = $(`#page-${num}`);
            if (pageDiv.hasClass('loaded') || num > pdfDoc.numPages || num < 1) return;

            const page = await pdfDoc.getPage(num);
            const canvas = pageDiv.find('canvas')[0];
            const context = canvas.getContext('2d');
            
            // Renderizziamo a 1.5 per mantenere qualità quando si zooma
            const viewport = page.getViewport({ scale: 1.5 });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            pageDiv.addClass('loaded');
        }

        $(document).ready(init);
    </script>
</body>
</html>
