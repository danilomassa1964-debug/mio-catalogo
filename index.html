<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Catalogo Serigrafia</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

    <style>
        body { background-color: #1a1a1a; color: white; text-align: center; font-family: sans-serif; margin: 0; overflow: hidden; }
        .toolbar {
            background: rgba(0,0,0,0.9);
            padding: 10px;
            position: fixed;
            top: 0; width: 100%;
            z-index: 1000;
            display: flex; justify-content: center; gap: 10px;
        }
        #canvas-container { 
            margin-top: 70px;
            transition: transform 0.3s ease;
            transform-origin: center top;
        }
        #flipbook { margin: 0 auto; display: none; }
        .page { background-color: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas { width: 100%; height: 100%; display: block; }
        button { 
            padding: 10px 15px; font-size: 14px; 
            background: #333; color: white; border: 1px solid #555; 
            border-radius: 5px; cursor: pointer;
        }
        #loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 2000;
            background: rgba(0,0,0,0.85);
            padding: 25px; border-radius: 15px;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <button onclick="changeZoom(-0.1)">➖</button>
        <button onclick="changeZoom(0.1)">➕</button>
        <button onclick="$('#flipbook').turn('previous')">← Prec</button>
        <button onclick="$('#flipbook').turn('next')">Succ →</button>
        <button onclick="window.open('./documento.pdf', '_blank')" style="background:#28a745">Scarica PDF</button>
    </div>

    <div id="loading">Preparazione catalogo...</div>
    
    <div id="canvas-container">
        <div id="flipbook"></div>
    </div>

    <script>
        let currentZoom = 1.0;
        let pdfDoc = null;
        // Rimuoviamo il timestamp per evitare problemi di cache durante i test
        const url = 'documento.pdf'; 
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        function changeZoom(delta) {
            currentZoom += delta;
            if (currentZoom < 0.5) currentZoom = 0.5;
            document.getElementById('canvas-container').style.transform = `scale(${currentZoom})`;
        }

        async function init() {
            try {
                // Caricamento standard (più stabile per file puliti)
                const loadingTask = pdfjsLib.getDocument(url);
                
                pdfDoc = await loadingTask.promise;
                const fb = $('#flipbook');
                const totalPages = pdfDoc.numPages;

                // Creazione rapida struttura
                for (let i = 1; i <= totalPages; i++) {
                    fb.append(`<div class="page" id="page-${i}"><canvas></canvas></div>`);
                }

                // Prendiamo le misure dalla pagina 1
                const firstPage = await pdfDoc.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1.5 });
                
                // Avvio Flipbook
                fb.show().turn({
                    width: viewport.width * 2,
                    height: viewport.height,
                    autoCenter: true,
                    display: 'double',
                    pages: totalPages,
                    when: {
                        turning: function(e, page) {
                            renderP(page);
                            if (page + 1 <= totalPages) renderP(page + 1);
                        }
                    }
                });

                // Renderizza subito le prime due pagine
                await renderP(1);
                await renderP(2);
                
                $('#loading').fadeOut();

            } catch (err) {
                console.error(err);
                $('#loading').text("Errore caricamento PDF. Verifica che il file 'documento.pdf' sia nella cartella.");
            }
        }

        async function renderP(num) {
            const pageDiv = $(`#page-${num}`);
            if (pageDiv.hasClass('loaded') || num > pdfDoc.numPages || num < 1) return;

            const page = await pdfDoc.getPage(num);
            const canvas = pageDiv.find('canvas')[0];
            const context = canvas.getContext('2d');
            const viewport = page.getViewport({ scale: 1.5 });

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            pageDiv.addClass('loaded');
        }

        $(document).ready(init);
    </script>
</body>
</html>
