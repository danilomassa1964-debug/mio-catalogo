<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Catalogo Interattivo Serigrafia</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

    <style>
        body { background-color: #1a1a1a; color: white; text-align: center; font-family: sans-serif; margin: 0; overflow: hidden; }
        .toolbar {
            background: rgba(0,0,0,0.9);
            padding: 10px;
            position: fixed;
            top: 0; width: 100%;
            z-index: 1000;
            display: flex; justify-content: center; gap: 10px;
            border-bottom: 1px solid #444;
        }
        #canvas-container { 
            margin-top: 70px;
            transition: transform 0.3s ease;
            transform-origin: center top;
        }
        #flipbook { margin: 0 auto; display: none; }
        .page { background-color: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas { width: 100%; height: 100%; display: block; }
        button { 
            padding: 10px 15px; font-size: 14px; 
            background: #333; color: white; border: 1px solid #555; 
            border-radius: 5px; cursor: pointer;
        }
        button:hover { background: #555; }
        .btn-download { background: #28a745; border-color: #1e7e34; }
        #loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 2000;
            background: rgba(0,0,0,0.8);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <button onclick="changeZoom(-0.1)">➖ Rimpicciolisci</button>
        <button onclick="changeZoom(0.1)">➕ Ingrandisci</button>
        <button onclick="$('#flipbook').turn('previous')">← Prec</button>
        <button onclick="$('#flipbook').turn('next')">Succ →</button>
        <button onclick="window.open('./documento.pdf', '_blank')" class="btn-download">⬇️ Scarica PDF</button>
    </div>

    <div id="loading">
        <div style="margin-bottom:10px;">Preparazione Catalogo...</div>
        <span id="percent">0</span>%
    </div>
    
    <div id="canvas-container">
        <div id="flipbook"></div>
    </div>

    <script>
        let currentZoom = 1.0;
        let pdfDoc = null;
        // Il timestamp forza il browser a non usare versioni vecchie in cache
        const url = './documento.pdf?v=' + new Date().getTime();
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        function changeZoom(delta) {
            currentZoom += delta;
            if (currentZoom < 0.5) currentZoom = 0.5;
            if (currentZoom > 2.0) currentZoom = 2.0;
            document.getElementById('canvas-container').style.transform = `scale(${currentZoom})`;
        }

        async function initCatalogue() {
            try {
                // Configurazione estrema per forzare il codice 206 e lo streaming
                const loadingTask = pdfjsLib.getDocument({
                    url: url,
                    disableAutoFetch: true, 
                    disableStream: false,   
                    disableRange: false,    // FORZA il caricamento a pezzi (Range Requests)
                    rangeChunkSize: 65536   
                });

                pdfDoc = await loadingTask.promise;
                const fb = $('#flipbook');
                const totalPages = pdfDoc.numPages;

                // Creiamo la struttura delle pagine
                for (let i = 1; i <= totalPages; i++) {
                    fb
